<!doctype html>
<html lang="vi">
<head>
  <script>
    // Load head (meta + links)
    fetch('../shared/head.html')
      .then(r => r.text())
      .then(html => {
        document.head.insertAdjacentHTML('afterbegin', html);
      });
    
    // Load styles
    fetch('../shared/styles.html')
      .then(r => r.text())
      .then(html => {
        document.head.insertAdjacentHTML('beforeend', html);
      });
  </script>
  <title>Chương 4: Bảo Mật API & WebSocket</title>
</head>
<body>
  <div class="reveal">
    <div class="slides">
      <section>
        <!-- Slide 1: Tiêu đề -->
        <section>
          <h1 class="chapter-title">Bảo Mật API & WebSocket</h1>
          <p style="font-size: 0.8em; margin-top: 2em;">Người trình bày: Đinh Việt Hoàng</p>
          <aside class="notes">
            <p><strong>Chương trình:</strong></p>
            <ol>
              <li>Tổng quan về Bảo mật Endpoint</li>
              <li>Bảo mật REST API (Tóm tắt)</li>
              <li>Thách thức của Bảo mật WebSocket</li>
              <li>Kiến trúc Bảo mật WebSocket 3 Lớp</li>
              <li>Luồng kết nối ví dụ (Agent vs. Widget)</li>
            </ol>
          </aside>
        </section>

        <!-- Slide 2: Bảo mật REST API -->
        <section>
            <div class="slide-content-card">
                <div class="layout-container">
                    <div class="left-column">
                        <svg class="slide-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14 20v-2a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v2" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M22 20v-2a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v2" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M18 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        <h2>Bảo mật REST API</h2>
                        <p style="font-size: 0.7em; margin-top: 1em; opacity: 0.8;">Phòng thủ theo chiều sâu</p>
                    </div>
                    <div class="right-column">
                        <table style="font-size: 0.75em; width: 100%;">
                            <thead>
                                <tr>
                                    <th style="text-align: left;">Biện pháp</th>
                                    <th style="text-align: left;">Công cụ</th>
                                    <th style="text-align: left;">Chức năng</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Authentication</strong></td>
                                    <td><code>jwt.guard.ts</code></td>
                                    <td>Xác thực JWT cho mọi request</td>
                                </tr>
                                <tr>
                                    <td><strong>Authorization</strong></td>
                                    <td><code>roles.guard.ts</code></td>
                                    <td>Phân quyền theo vai trò</td>
                                </tr>
                                <tr>
                                    <td><strong>Input Validation</strong></td>
                                    <td><code>ValidationPipe</code></td>
                                    <td>Xác thực & làm sạch DTOs</td>
                                </tr>
                                <tr>
                                    <td><strong>CORS</strong></td>
                                    <td><code>app.enableCors()</code></td>
                                    <td>Kiểm soát domain nguồn</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <aside class="notes">
                <p>Bảo mật cho các API RESTful của chúng ta được xây dựng trên bốn trụ cột chính, tạo thành một hệ thống phòng thủ theo chiều sâu:</p>
                <ul>
                    <li><strong>Authentication (jwt.guard.ts):</strong> Đảm bảo mọi request (trừ các endpoint được đánh dấu @Public) phải có một JWT hợp lệ trong header Authorization.</li>
                    <li><strong>Authorization (roles.guard.ts):</strong> Sau khi xác thực, guard này sẽ thực thi việc phân quyền dựa trên vai trò (cả GlobalRole và ProjectRole) cho các endpoint được đánh dấu @Roles().</li>
                    <li><strong>Input Validation (ValidationPipe):</strong> Được áp dụng toàn cục, ValidationPipe tự động xác thực và làm sạch dữ liệu DTOs đến, bảo vệ hệ thống khỏi dữ liệu không hợp lệ và các cuộc tấn công injection cơ bản.</li>
                    <li><strong>CORS (app.enableCors()):</strong> Kiểm soát chặt chẽ các domain nào từ phía trình duyệt được phép gửi request đến API, ngăn chặn các cuộc tấn công Cross-Site Request Forgery (CSRF) đơn giản.</li>
                </ul>
            </aside>
        </section>

        <!-- Slide 3: Thách thức WebSocket -->
        <section>
            <div class="slide-content-card">
                <div class="layout-container">
                    <div class="left-column">
                        <svg class="slide-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10 22v-2M14 22v-2M10 22h4" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 20a4.002 4.002 0 0 0 4-4V8a4 4 0 1 0-8 0v8a4.002 4.002 0 0 0 4 4Z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 8v8" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        <h2>Thách thức WebSocket</h2>
                    </div>
                    <div class="right-column">
                        <div style="margin-bottom: 1.5em;">
                            <h4 style="color: #3b82f6; margin-bottom: 0.5em;">REST API: Stateless</h4>
                            <p style="font-size: 0.75em;">Mỗi request là giao dịch độc lập. Xác thực trên từng request với JWT trong header.</p>
                        </div>
                        <div style="margin-bottom: 1.5em;">
                            <h4 style="color: #ef4444; margin-bottom: 0.5em;">WebSocket: Stateful</h4>
                            <p style="font-size: 0.75em;">Kết nối bền vững, xác thực <strong>một lần</strong> lúc handshake. Toàn bộ phiên phải được bảo vệ.</p>
                        </div>
                        <div style="background: rgba(59, 130, 246, 0.1); padding: 1em; border-radius: 8px;">
                            <h5 style="margin-bottom: 0.5em;">Hai loại Client:</h5>
                            <ul style="font-size: 0.75em; margin: 0;">
                                <li><strong>Đã xác thực:</strong> Agent/Manager (có JWT)</li>
                                <li><strong>Ẩn danh:</strong> Widget Khách hàng (không có JWT)</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <aside class="notes">
                <p><strong>Tại sao WebSocket cần một mô hình bảo mật riêng?</strong></p>
                <p>Không giống như REST API, WebSocket có những đặc thù riêng đòi hỏi một phương pháp tiếp cận bảo mật khác biệt.</p>
                <ul>
                    <li><strong>REST API: Stateless (Phi trạng thái)</strong> - Mỗi request HTTP là một giao dịch độc lập, tự chứa. Client gửi một request, server xử lý và trả về một response, sau đó kết nối đóng lại. Việc xác thực được thực hiện trên từng request bằng cách gửi JWT trong header.</li>
                    <li><strong>WebSocket: Stateful (Có trạng thái)</strong> - Client và server thiết lập một kết nối bền vững (persistent connection). Kết nối này được duy trì để cho phép giao tiếp hai chiều bất cứ lúc nào. Do đó, việc xác thực chỉ cần thực hiện MỘT LẦN vào lúc bắt đầu kết nối (handshake). Toàn bộ phiên kết nối sau đó phải được bảo vệ.</li>
                </ul>
                <p><strong>Hai loại Client của Hệ thống:</strong></p>
                <p>Kiến trúc của chúng ta phải hỗ trợ đồng thời hai loại client có nhu cầu bảo mật hoàn toàn khác nhau:</p>
                <ol>
                    <li><strong>Người dùng đã xác thực (Authenticated Users):</strong> Là các Agent hoặc Manager sử dụng ứng dụng web chính của chúng ta. Họ CÓ JWT sau khi đăng nhập và cần được phân quyền để truy cập dữ liệu của các dự án cụ thể.</li>
                    <li><strong>Khách truy cập ẩn danh (Anonymous Visitors):</strong> Là những người dùng cuối tương tác với widget trò chuyện được nhúng trên các trang web của khách hàng. Họ KHÔNG CÓ JWT và phải được phép kết nối để bắt đầu một cuộc trò chuyện.</li>
                </ol>
            </aside>
        </section>

        <!-- Slide 4: Kiến trúc 3 Lớp -->
        <section>
            <div class="slide-content-card">
                <div class="layout-container">
                    <div class="left-column">
                        <svg class="slide-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10Z" stroke-width="1.5"/><path d="M12 16a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z" stroke-width="1.5"/><path d="M12 12c-2.5 0-2.5-4-2.5-4M12 12c2.5 0 2.5-4 2.5-4M12 12c-2.5 0-2.5 4-2.5 4M12 12c2.5 0 2.5 4 2.5 4" stroke-width="1.5" stroke-linecap="round"/></svg>
                        <h2>Kiến trúc 3 Lớp</h2>
                        <p style="font-size: 0.7em; margin-top: 1em; opacity: 0.8;">Phòng thủ theo chiều sâu cho WebSocket</p>
                        <div style="margin-top: 2em; font-size: 0.7em; text-align: left;">
                            <div style="margin-bottom: 0.8em; padding: 0.5em; background: rgba(59, 130, 246, 0.1); border-left: 3px solid #3b82f6;">
                                <strong>1. Domain Whitelist</strong><br/>
                                <span style="opacity: 0.8;">Chặn domain lạ</span>
                            </div>
                            <div style="margin-bottom: 0.8em; padding: 0.5em; background: rgba(16, 185, 129, 0.1); border-left: 3px solid #10b981;">
                                <strong>2. User Authentication</strong><br/>
                                <span style="opacity: 0.8;">Xác định danh tính</span>
                            </div>
                            <div style="padding: 0.5em; background: rgba(245, 158, 11, 0.1); border-left: 3px solid #f59e0b;">
                                <strong>3. Room Authorization</strong><br/>
                                <span style="opacity: 0.8;">Cô lập dữ liệu dự án</span>
                            </div>
                        </div>
                    </div>
                    <div class="right-column">
                        <div class="mermaid" style="font-size: 0.8em;">
                            graph TD
                                A[Kết nối WebSocket đến] --> B{Lớp 1: Whitelisting Domain};
                                B -- "Origin hợp lệ" --> C{Lớp 2: User Authentication};
                                C -- "Đã xác thực hoặc Ẩn danh" --> D{Lớp 3: Room Authorization};
                                D -- "Đã tham gia Room" --> E[Kết nối thành công và an toàn];
                                B -- "Origin KHÔNG hợp lệ" --> F[Từ chối kết nối];
                                C -- "Token KHÔNG hợp lệ" --> F;
                                style E fill:#10b981,stroke:#333,stroke-width:2px,color:#fff
                                style F fill:#ef4444,stroke:#333,stroke-width:2px,color:#fff
                                style A fill:#3b82f6,stroke:#333,stroke-width:2px,color:#fff
                        </div>
                    </div>
                </div>
            </div>
            <aside class="notes">
                <p><strong>Một mô hình phòng thủ theo chiều sâu cho giao tiếp thời gian thực</strong></p>
                <p>Để giải quyết các thách thức trên, chúng ta đã xây dựng một mô hình bảo mật gồm 3 lớp riêng biệt. Mọi kết nối WebSocket đều phải đi qua cả 3 lớp này.</p>
                <ol>
                    <li>
                        <strong>Lớp 1: Whitelisting Domain (RedisIoAdapter)</strong>
                        <ul>
                            <li><strong>Mục tiêu:</strong> Ngăn chặn các trang web lạ kết nối.</li>
                            <li><strong>Cơ chế:</strong> Kiểm tra header 'origin' của kết nối. Chỉ cho phép các kết nối từ frontend chính của chúng ta, hoặc từ một domain đã được chủ dự án thêm vào "danh sách trắng" (whitelisted domains) trong cài đặt.</li>
                        </ul>
                    </li>
                    <li>
                        <strong>Lớp 2: User Authentication (WsJwtAuthGuard)</strong>
                        <ul>
                            <li><strong>Mục tiêu:</strong> Xác định danh tính của người dùng (nếu có).</li>
                            <li><strong>Cơ chế:</strong> Kiểm tra sự tồn tại của JWT trong handshake.auth.token.
                                <ul>
                                    <li>Nếu có token (Agent/Manager), guard sẽ xác thực nó và gắn thông tin 'user' vào socket.</li>
                                    <li>Nếu không có token (Widget ẩn danh), guard cho phép kết nối đi tiếp.</li>
                                </ul>
                            </li>
                        </ul>
                    </li>
                    <li>
                        <strong>Lớp 3: Room-Based Authorization (EventsGateway)</strong>
                        <ul>
                            <li><strong>Mục tiêu:</strong> Đảm bảo người dùng chỉ nhận được dữ liệu họ được phép xem.</li>
                            <li><strong>Cơ chế:</strong> Một kết nối sau khi được xác thực vẫn chưa có quyền truy cập dữ liệu nào. Client phải gửi một event 'joinProjectRoom' để tham gia vào một "room" cụ thể của dự án (ví dụ: 'project:123'). Server chỉ phát các sự kiện và tin nhắn tới các thành viên trong room đó, đảm bảo dữ liệu được cô lập hoàn toàn giữa các dự án.</li>
                        </ul>
                    </li>
                </ol>
            </aside>
        </section>

        <!-- Slide 5: Luồng kết nối ví dụ -->
        <section>
            <div class="slide-content-card">
                <div class="layout-container">
                    <div class="left-column">
                        <svg class="slide-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10 16.99v-1.5a3.5 3.5 0 0 0-3.5-3.5H3" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M14 7.01v1.5a3.5 3.5 0 0 0 3.5 3.5H21" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="m6 12 3-3-3-3M18 12l-3 3 3 3" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        <h2>Luồng kết nối ví dụ</h2>
                        <p style="font-size: 0.7em; margin-top: 1em; opacity: 0.8;">So sánh Agent vs Widget</p>
                    </div>
                    <div class="right-column">
                        <div style="display: flex; justify-content: space-around; gap: 1em;">
                            <div style="flex: 1; text-align: center; background: rgba(59, 130, 246, 0.05); padding: 1em; border-radius: 8px;">
                                <h5 style="color: #3b82f6; margin-bottom: 0.8em;">🔐 Agent Đăng nhập</h5>
                                <div class="mermaid" style="font-size: 0.65em;">
                                    sequenceDiagram
                                        participant Client as Agent App
                                        participant L1 as Lớp 1
                                        participant L2 as Lớp 2
                                        participant L3 as Lớp 3
                                        
                                        Client->>L1: Kết nối (có JWT)
                                        activate L1
                                        L1-->>Client: ✓ Origin OK
                                        deactivate L1
                                        
                                        Client->>L2: Handshake + JWT
                                        activate L2
                                        L2-->>Client: ✓ User attached
                                        deactivate L2
                                        
                                        Client->>L3: joinProjectRoom(123)
                                        activate L3
                                        L3-->>Client: ✓ Joined room
                                        deactivate L3
                                </div>
                            </div>
                            <div style="flex: 1; text-align: center; background: rgba(16, 185, 129, 0.05); padding: 1em; border-radius: 8px;">
                                <h5 style="color: #10b981; margin-bottom: 0.8em;">🌐 Widget Khách hàng</h5>
                                <div class="mermaid" style="font-size: 0.65em;">
                                    sequenceDiagram
                                        participant Client as Widget
                                        participant L1 as Lớp 1
                                        participant L2 as Lớp 2
                                        participant L3 as Lớp 3
                                        
                                        Client->>L1: Kết nối (ẩn danh)
                                        activate L1
                                        L1-->>Client: ✓ Domain whitelisted
                                        deactivate L1
                                        
                                        Client->>L2: Handshake (no JWT)
                                        activate L2
                                        L2-->>Client: ✓ Anonymous OK
                                        deactivate L2
                                        
                                        Client->>L3: identify(visitorUid)
                                        activate L3
                                        L3-->>Client: ✓ Session created
                                        deactivate L3
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <aside class="notes">
                <p><strong>Minh họa hoạt động của kiến trúc 3 lớp</strong></p>
                
                <p><strong>Kịch bản 1: Agent Đăng nhập</strong></p>
                <ol>
                    <li>Agent App gửi yêu cầu kết nối từ app.our-domain.com với JWT trong handshake.</li>
                    <li>Lớp 1 (Adapter) kiểm tra origin và xác nhận OK vì đây là domain chính.</li>
                    <li>Lớp 2 (Guard) xác thực JWT, nếu hợp lệ sẽ gắn thông tin user vào socket.</li>
                    <li>Agent gửi event "joinProjectRoom" với projectId: 123.</li>
                    <li>Lớp 3 (Gateway) thêm socket vào room "project:123", kết nối thành công và Agent có thể nhận/gửi dữ liệu của dự án này.</li>
                </ol>
                
                <p><strong>Kịch bản 2: Widget của Khách hàng</strong></p>
                <ol>
                    <li>Widget được nhúng trên customer.com gửi yêu cầu kết nối với projectId: 456.</li>
                    <li>Lớp 1 (Adapter) kiểm tra xem domain "customer.com" có trong danh sách whitelist của project 456 không. Nếu có → OK.</li>
                    <li>Lớp 2 (Guard) phát hiện không có JWT trong handshake, nhưng cho phép vì đây là kết nối ẩn danh hợp lệ.</li>
                    <li>Widget gửi event "identify" với visitorUid: "abc-123".</li>
                    <li>Lớp 3 (Gateway) tạo session cho visitor này và kết nối thành công. Visitor có thể bắt đầu trò chuyện.</li>
                </ol>
            </aside>
        </section>
      </section>

    </div>
  </div>
  
  <script>
    // Load scripts sau khi DOM ready
    window.addEventListener('DOMContentLoaded', () => {
      fetch('../shared/scripts.html')
        .then(r => r.text())
        .then(html => {
          document.body.insertAdjacentHTML('beforeend', html);
        });
    });
  </script>
</body>
</html>